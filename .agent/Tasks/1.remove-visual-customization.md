# Remove Visual Customization - Implementation Plan

## Context

Visual customization was added to give users control over colors and dimensions. This introduced significant complexity for a feature that's rarely needed. We're reverting to a single default visual style to reduce codebase complexity.

## Goal

Remove all dynamic visual customization while keeping the current default look and feel.

## Planning Decisions (2025-10-12)

**Database Migration Strategy:**
- Write proper migration (`002_remove_visual_settings.sql`) to drop table while preserving flow data
- Keep both `001_initial.sql` and `002_remove_visual_settings.sql` for migration history (cleanest approach)

**Group Node Styling:**
- Include group node hardcoded colors (indigo theme) from current defaults:
  - `background: '#3730a3'`, `border: '#6366f1'`, `text: '#ffffff'`

**Shared Code Approach:**
- Create `src/constants/theme.js` for hardcoded styling constants
- Delete `shared/visualSettings.js` entirely (no longer needed)

**LLM Tool Removal:**
- Remove `changeVisuals` and `changeDimensions` tools from LLM (confirmed - aligns with goal)
- Update tool count documentation from 13 → 11 tools

**Timeline:**
- Planning only until frontend-coverage branch work is complete
- Will receive branch strategy when ready to start implementation

## Implementation Phases

### Phase 1: Remove AI Customization Tools

**Files to Modify:**
- `server/llm/tools.js` - Remove tool definitions
- `server/tools/executor.js` - Remove executor functions
- `server/llm/llmService.js` - Remove visual settings from context

**Changes:**

1. **server/llm/tools.js**
   - Remove `changeVisuals` tool definition (lines 167-194)
   - Remove `changeDimensions` tool definition (lines 195-223)

2. **server/tools/executor.js**
   - Remove `executeChangeVisuals()` function (~54 lines)
   - Remove `executeChangeDimensions()` function (~79 lines)
   - Remove cases from `executeTool()` switch:
     - `case 'changeVisuals':`
     - `case 'changeDimensions':`
   - Remove helper functions:
     - `isValidCssColor()`
     - `adjustByPercentage()`
     - `clamp()`
   - Remove `readSettings()` function
   - Remove `writeSettings()` function
   - Remove `cloneSettings()` function
   - Remove `settings` parameter from `executeTool()` signature
   - Remove `settings` tracking in `executeToolCalls()`

3. **server/llm/llmService.js**
   - Remove visual settings from `buildLLMContext()` function
   - Remove any references to settings in context messages

### Phase 2: Remove Database Layer

**Files to Create:**
- `server/migrations/002_remove_visual_settings.sql` - New migration to drop table

**Files to Modify:**
- `server/db.js` - Remove functions

**Changes:**

1. **Create server/migrations/002_remove_visual_settings.sql**
   ```sql
   -- Remove visual_settings table (no longer needed - using hardcoded theme)
   DROP TABLE IF EXISTS visual_settings;
   ```

2. **server/db.js**
   - Ensure migration system runs `002_remove_visual_settings.sql` on startup
   - Remove `getVisualSettings()` function
   - Remove `saveVisualSettings()` function
   - Remove imports: `DEFAULT_VISUAL_SETTINGS`, `mergeWithDefaultVisualSettings`

**Migration Notes:**
- Existing flow data will be preserved
- Only `visual_settings` table is dropped
- Keep both `001_initial.sql` and `002_remove_visual_settings.sql` for migration history

### Phase 3: Create Theme Constants

**Files to Create:**
- `src/constants/theme.js` - Centralized hardcoded styling

**Changes:**

1. **Create src/constants/theme.js**
   ```javascript
   // ABOUTME: Hardcoded theme constants for Visual Scaffolding
   // ABOUTME: Single source of truth for all visual styling

   export const THEME = {
     colors: {
       background: 'linear-gradient(180deg, #0f0a1a 0%, #1a0f2e 100%)',
       node: {
         background: '#1a192b',
         border: '#2b2253',
         text: '#ffffff',
       },
       groupNode: {
         background: '#3730a3',
         border: '#6366f1',
         text: '#ffffff',
       },
     },
     dimensions: {
       node: {
         width: 172,
         height: 76,
         borderRadius: 4,
       },
       dagre: {
         horizontal: 50,
         vertical: 50,
       },
       fitViewPadding: 0.25,
     },
   };
   ```

### Phase 4: Simplify Frontend

**Files to Modify:**
- `src/App.jsx` - Remove state and dynamic styling
- `src/hooks/useFlowLayout.js` - Remove settings parameter
- `src/api.js` - Remove settings from responses

**Changes:**

1. **src/App.jsx**
   - Import `THEME` from `src/constants/theme.js`
   - Remove `visualSettings` state variable
   - Remove `mergeWithDefaultVisualSettings` import
   - Remove settings update in `handleFlowUpdate()` function
   - Use `THEME.colors.background` for background style
   - Use `THEME.colors.node.*` for regular node styling
   - Use `THEME.colors.groupNode.*` for group node styling
   - Use `THEME.dimensions.node.*` for node dimensions
   - Remove `visualSettings` from dependencies arrays

2. **src/hooks/useFlowLayout.js**
   - Import `THEME` from `src/constants/theme.js`
   - Remove `visualSettings` parameter from `useFlowLayout()` hook
   - Remove `visualSettings` parameter from `getLayoutedElements()` function
   - Use `THEME.dimensions.dagre.*` for dagre spacing
   - Use `THEME.dimensions.node.*` for node dimensions
   - Use `THEME.dimensions.fitViewPadding` for fit view padding

3. **src/api.js**
   - Remove `settings` from `loadFlow()` response structure
   - Update type: `Promise<{ nodes: Node[], edges: Edge[] }>`

4. **server/server.js**
   - Remove `getVisualSettings()` import
   - Remove settings from `GET /api/flow` response
   - Only return `{ nodes, edges }`

### Phase 5: Clean Up Shared Code

**Files to Delete:**
- `shared/visualSettings.js` - No longer needed (replaced by `src/constants/theme.js`)

**Rationale:**
- Theme constants now live in frontend at `src/constants/theme.js`
- Backend no longer needs visual settings (no dynamic customization)
- Cleaner separation: frontend owns styling, backend owns data

### Phase 6: Remove Tests

**Files to Delete:**
- `tests/visual-settings-e2e.test.js`
- `tests/visual-settings-llm.test.js`
- `tests/visual-settings-rendering.test.js`

**Files to Modify:**
- `tests/api-contracts.test.js` - Remove visual settings assertions
- `tests/db.test.js` - Remove `getVisualSettings()` and `saveVisualSettings()` tests
- `tests/toolExecution.test.js` - Remove `changeVisuals` and `changeDimensions` tests

**Changes:**

1. **tests/api-contracts.test.js**
   - Remove any assertions checking for `settings` in responses
   - Update expected response shape to `{ nodes, edges }`

2. **tests/db.test.js**
   - Remove test cases for visual settings functions

3. **tests/toolExecution.test.js**
   - Remove all test cases for `changeVisuals`
   - Remove all test cases for `changeDimensions`

### Phase 7: Update Documentation

**Files to Modify:**
- `.agent/system/project_architecture.md`
- `.agent/system/database_schema.md`
- `.agent/system/llm_integration.md`

**Changes:**

1. **.agent/system/project_architecture.md**
   - Remove visual customization from "Core Features" section
   - Remove `changeVisuals` and `changeDimensions` from "Available Tools" section
   - Update tool count from 13 to 11 tools
   - Remove visual settings references from "Frontend Architecture" → "Data Flow"
   - Remove `visual_settings` table from "Database Schema" section reference
   - Add `src/constants/theme.js` to project structure
   - Remove `shared/visualSettings.js` from project structure

2. **.agent/system/database_schema.md**
   - Remove entire `visual_settings` table section
   - Update table count from 5 to 4 tables
   - Remove visual settings from "Loading Flow Data" section
   - Remove visual settings from "LLM Message Processing" section
   - Add migration `002_remove_visual_settings.sql` to migration history

3. **.agent/system/llm_integration.md**
   - Remove "Visual Settings Snapshot" from context building section
   - Remove `changeVisuals` from tool list
   - Remove `changeDimensions` from tool list
   - Update tool count from 13 to 11 tools

---

## Testing Requirements

### Automated Tests (My Responsibility)

After each phase, run:
```bash
npm test
```

**Expected outcomes:**

1. **After Phase 1-2**:
   - All existing tests pass (visual tests not yet removed)
   - Tools execute without visual customization
   - Database migration runs successfully

2. **After Phase 3-5**:
   - Frontend renders with hardcoded theme constants
   - No console errors about missing settings
   - `shared/visualSettings.js` successfully deleted

3. **After Phase 6**:
   - All tests pass
   - Test count reduced by ~3 files
   - No test references to visual customization

**Specific test validations:**
- `tests/toolExecution.test.js` - Verify no changeVisuals/changeDimensions tests remain
- `tests/db.test.js` - Verify no visual_settings function tests remain
- `tests/api-contracts.test.js` - Verify responses don't include settings
- All other tests continue to pass

### Manual Tests (Your Responsibility)

After implementation is complete and all automated tests pass:

**1. Visual Consistency Check**
- [ ] Load the application - background should be purple gradient
- [ ] Create nodes manually (Cmd+Double-click) - should have purple background
- [ ] Nodes should have white text on dark purple background
- [ ] Layout spacing should look identical to before

**2. AI Flow Generation**
- [ ] Chat: "create a login flow"
- [ ] Verify nodes are created with default styling
- [ ] Verify no visual customization commands work
- [ ] Chat: "make the background red" → Should respond that visual customization is not available (LLM will naturally respond this way since the tools are removed)

**3. Core Functionality Intact**
- [ ] Create nodes via chat
- [ ] Edit node labels (double-click)
- [ ] Create edges via chat
- [ ] Undo/Redo (Cmd+Z / Cmd+Shift+Z)
- [ ] Group nodes (Cmd+G)
- [ ] Collapse/expand groups (double-click)
- [ ] Ungroup (Cmd+Shift+G)
- [ ] Verify auto-layout works

**4. Database Migration**
- [ ] Verify `server/data/flow.db` was migrated (not recreated - existing flows preserved)
- [ ] Open SQLite: `sqlite3 server/data/flow.db`
- [ ] Run: `.tables` - should only show: `flows`, `conversation_history`, `undo_history`, `undo_state`
- [ ] Verify no `visual_settings` table exists
- [ ] Verify your existing flows are still present (if any existed before migration)

**5. Performance Check**
- [ ] AI responses should feel slightly faster (no visual context sent)
- [ ] No console warnings or errors
- [ ] Autosave still works (500ms debounce)

---

## Rollback Plan

If issues arise:

1. **Git**: Revert commits from this implementation
2. **Database**: Restore `server/data/flow.db` from backup
3. **Tests**: Visual settings tests will be back in place

---

## Expected Outcomes

**Code Reduction:**
- ~500 lines of production code removed
- ~400+ lines of test code removed
- 1 database table removed
- 2 AI tools removed

**Simplification:**
- Single source of styling truth (defaults only)
- No dynamic style merging logic
- Simpler LLM context (smaller payloads)
- Easier mental model for developers

**No User Impact:**
- Visual appearance unchanged (uses current defaults)
- All core features work identically
- Slightly faster AI responses

---

## Implementation Checklist

Use this during implementation:

- [ ] Phase 1: Remove AI customization tools (`changeVisuals`, `changeDimensions`)
- [ ] Phase 2: Remove database layer (create migration, remove functions)
- [ ] Phase 3: Create theme constants (`src/constants/theme.js`)
- [ ] Phase 4: Simplify frontend (use theme constants)
- [ ] Phase 5: Clean up shared code (delete `shared/visualSettings.js`)
- [ ] Phase 6: Remove tests (3 test files + test cases in other files)
- [ ] Phase 7: Update documentation (architecture, schema, LLM docs)
- [ ] Run full test suite
- [ ] Request Edu's manual testing
- [ ] Address any issues found
- [ ] Mark task complete

---

**Status**: Not Started
**Created**: 2025-10-12
**Owner**: Claude
**Reviewer**: Edu
