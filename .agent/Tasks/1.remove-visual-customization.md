# Remove Visual Customization - Implementation Plan

## Context

Visual customization was added to give users control over colors and dimensions. This introduced significant complexity for a feature that's rarely needed. We're reverting to a single default visual style to reduce codebase complexity.

## Goal

Remove all dynamic visual customization while keeping the current default look and feel.

## Implementation Phases

### Phase 1: Remove AI Customization Tools

**Files to Modify:**
- `server/llm/tools.js` - Remove tool definitions
- `server/tools/executor.js` - Remove executor functions
- `server/llm/llmService.js` - Remove visual settings from context

**Changes:**

1. **server/llm/tools.js**
   - Remove `changeVisuals` tool definition (lines 167-194)
   - Remove `changeDimensions` tool definition (lines 195-223)

2. **server/tools/executor.js**
   - Remove `executeChangeVisuals()` function (~54 lines)
   - Remove `executeChangeDimensions()` function (~79 lines)
   - Remove cases from `executeTool()` switch:
     - `case 'changeVisuals':`
     - `case 'changeDimensions':`
   - Remove helper functions:
     - `isValidCssColor()`
     - `adjustByPercentage()`
     - `clamp()`
   - Remove `readSettings()` function
   - Remove `writeSettings()` function
   - Remove `cloneSettings()` function
   - Remove `settings` parameter from `executeTool()` signature
   - Remove `settings` tracking in `executeToolCalls()`

3. **server/llm/llmService.js**
   - Remove visual settings from `buildLLMContext()` function
   - Remove any references to settings in context messages

### Phase 2: Remove Database Layer

**Files to Modify:**
- `server/migrations/001_initial.sql` - Remove table creation
- `server/db.js` - Remove functions

**Changes:**

1. **server/migrations/001_initial.sql**
   - Remove `visual_settings` table creation and initialization (entire section)

2. **server/db.js**
   - Remove `getVisualSettings()` function
   - Remove `saveVisualSettings()` function
   - Remove imports: `DEFAULT_VISUAL_SETTINGS`, `mergeWithDefaultVisualSettings`

3. **Delete database file to trigger clean migration:**
   - `rm server/data/flow.db`
   - On next startup, fresh DB will be created without visual_settings table

### Phase 3: Simplify Frontend

**Files to Modify:**
- `src/App.jsx` - Remove state and dynamic styling
- `src/hooks/useFlowLayout.js` - Remove settings parameter
- `src/api.js` - Remove settings from responses

**Changes:**

1. **src/App.jsx**
   - Remove `visualSettings` state variable
   - Remove `mergeWithDefaultVisualSettings` import
   - Remove settings update in `handleFlowUpdate()` function
   - Hardcode background style directly:
     ```javascript
     style={{ background: 'linear-gradient(180deg, #0f0a1a 0%, #1a0f2e 100%)' }}
     ```
   - Remove `getNodeDimensions()` callback - use defaults directly:
     ```javascript
     style={{
       width: 172,
       height: 76,
       borderRadius: 4,
       // ... rest of styles
     }}
     ```
   - Remove dynamic color logic - use defaults directly:
     ```javascript
     background: '#1a192b',
     borderColor: '#2b2253',
     color: '#ffffff',
     ```
   - Remove `visualSettings` from dependencies arrays

2. **src/hooks/useFlowLayout.js**
   - Remove `visualSettings` parameter from `useFlowLayout()` hook
   - Remove `visualSettings` parameter from `getLayoutedElements()` function
   - Hardcode dagre spacing directly:
     ```javascript
     g.setGraph({
       rankdir: direction,
       nodesep: 50,
       ranksep: 50,
       marginx: 10,
       marginy: 10,
     });
     ```
   - Use default node dimensions directly:
     ```javascript
     g.setNode(node.id, { width: 172, height: 76 });
     ```
   - Hardcode `fitViewPadding` to `0.25`

3. **src/api.js**
   - Remove `settings` from `loadFlow()` response structure
   - Update type: `Promise<{ nodes: Node[], edges: Edge[] }>`

4. **server/server.js**
   - Remove settings from `GET /api/flow` response
   - Only return `{ nodes, edges }`

### Phase 4: Clean Up Shared Code

**Files to Modify:**
- `shared/visualSettings.js` - Simplify or inline

**Options:**

**Option A: Keep file with simplified export**
```javascript
// ABOUTME: Default visual settings for canvas and nodes
// ABOUTME: Single source of truth for application styling

export const DEFAULT_VISUAL_SETTINGS = {
  colors: {
    background: 'linear-gradient(180deg, #0f0a1a 0%, #1a0f2e 100%)',
    node: {
      background: '#1a192b',
      border: '#2b2253',
      text: '#ffffff',
    },
  },
  dimensions: {
    node: {
      width: 172,
      height: 76,
      borderRadius: 4,
    },
    dagre: {
      horizontal: 50,
      vertical: 50,
    },
    fitViewPadding: 0.25,
  },
};
```

**Option B: Delete file and inline values**
- Remove `shared/visualSettings.js` entirely
- Define constants directly in components where needed

**Recommendation: Option A** - Keeps styling centralized if we ever need to tweak defaults.

### Phase 5: Remove Tests

**Files to Delete:**
- `tests/visual-settings-e2e.test.js`
- `tests/visual-settings-llm.test.js`
- `tests/visual-settings-rendering.test.js`

**Files to Modify:**
- `tests/api-contracts.test.js` - Remove visual settings assertions
- `tests/db.test.js` - Remove `getVisualSettings()` and `saveVisualSettings()` tests
- `tests/toolExecution.test.js` - Remove `changeVisuals` and `changeDimensions` tests

**Changes:**

1. **tests/api-contracts.test.js**
   - Remove any assertions checking for `settings` in responses
   - Update expected response shape to `{ nodes, edges }`

2. **tests/db.test.js**
   - Remove test cases for visual settings functions

3. **tests/toolExecution.test.js**
   - Remove all test cases for `changeVisuals`
   - Remove all test cases for `changeDimensions`

### Phase 6: Update Documentation

**Files to Modify:**
- `.agent/system/project_architecture.md`
- `.agent/system/database_schema.md`
- `.agent/system/llm_integration.md`

**Changes:**

1. **.agent/system/project_architecture.md**
   - Remove visual customization from "Core Features" section (line 118-119)
   - Remove `changeVisuals` and `changeDimensions` from "Available Tools" section
   - Update tool count from 13 to 11 tools
   - Remove visual settings references from "Frontend Architecture" → "Data Flow"
   - Remove `visual_settings` table from "Database Schema" section reference

2. **.agent/system/database_schema.md**
   - Remove entire `visual_settings` table section (lines 70-124)
   - Update table count from 4 to 3 tables
   - Remove visual settings from "Loading Flow Data" section
   - Remove visual settings from "LLM Message Processing" section

3. **.agent/system/llm_integration.md**
   - Remove "Visual Settings Snapshot" from context building section
   - Remove `changeVisuals` from tool list
   - Remove `changeDimensions` from tool list
   - Update tool count

---

## Testing Requirements

### Automated Tests (My Responsibility)

After each phase, run:
```bash
npm test
```

**Expected outcomes:**

1. **After Phase 1-2**:
   - All existing tests pass (visual tests not yet removed)
   - Tools execute without visual customization

2. **After Phase 3**:
   - Frontend renders with hardcoded defaults
   - No console errors about missing settings

3. **After Phase 5**:
   - All tests pass
   - Test count reduced by ~3 files
   - No test references to visual customization

**Specific test validations:**
- `tests/toolExecution.test.js` - Verify no changeVisuals/changeDimensions tests remain
- `tests/db.test.js` - Verify no visual_settings function tests remain
- `tests/api-contracts.test.js` - Verify responses don't include settings
- All other tests continue to pass

### Manual Tests (Your Responsibility)

After implementation is complete and all automated tests pass:

**1. Visual Consistency Check**
- [ ] Load the application - background should be purple gradient
- [ ] Create nodes manually (Cmd+Double-click) - should have purple background
- [ ] Nodes should have white text on dark purple background
- [ ] Layout spacing should look identical to before

**2. AI Flow Generation**
- [ ] Chat: "create a login flow"
- [ ] Verify nodes are created with default styling
- [ ] Verify no visual customization commands work
- [ ] Chat: "make the background red" → Should respond that this is not possible

**3. Core Functionality Intact**
- [ ] Create nodes via chat
- [ ] Edit node labels (double-click)
- [ ] Create edges via chat
- [ ] Undo/Redo (Cmd+Z / Cmd+Shift+Z)
- [ ] Group nodes (Cmd+G)
- [ ] Collapse/expand groups (double-click)
- [ ] Ungroup (Cmd+Shift+G)
- [ ] Verify auto-layout works

**4. Database Migration**
- [ ] Verify `server/data/flow.db` was recreated without visual_settings table
- [ ] Open SQLite: `sqlite3 server/data/flow.db`
- [ ] Run: `.tables` - should only show: `flows`, `conversation_history`, `undo_history`, `undo_state`
- [ ] Verify no `visual_settings` table exists

**5. Performance Check**
- [ ] AI responses should feel slightly faster (no visual context sent)
- [ ] No console warnings or errors
- [ ] Autosave still works (500ms debounce)

---

## Rollback Plan

If issues arise:

1. **Git**: Revert commits from this implementation
2. **Database**: Restore `server/data/flow.db` from backup
3. **Tests**: Visual settings tests will be back in place

---

## Expected Outcomes

**Code Reduction:**
- ~500 lines of production code removed
- ~400+ lines of test code removed
- 1 database table removed
- 2 AI tools removed

**Simplification:**
- Single source of styling truth (defaults only)
- No dynamic style merging logic
- Simpler LLM context (smaller payloads)
- Easier mental model for developers

**No User Impact:**
- Visual appearance unchanged (uses current defaults)
- All core features work identically
- Slightly faster AI responses

---

## Implementation Checklist

Use this during implementation:

- [ ] Phase 1: Remove AI tools from backend
- [ ] Phase 2: Remove database layer
- [ ] Phase 3: Simplify frontend
- [ ] Phase 4: Clean up shared code
- [ ] Phase 5: Remove tests
- [ ] Phase 6: Update documentation
- [ ] Run full test suite
- [ ] Request Edu's manual testing
- [ ] Address any issues found
- [ ] Mark task complete

---

**Status**: Not Started
**Created**: 2025-10-12
**Owner**: Claude
**Reviewer**: Edu
